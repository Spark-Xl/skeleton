<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="style.css" />
    <script data-require="jquery@*" data-semver="3.1.1" src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    
    <script>
        const api = "http://localhost:8080";

        var allReceipts;
        $(reloadReceipts)

        function reloadReceipts() {
            $(".receipt").remove();

            $.getJSON(api+"/receipts", function(receipts){
                allReceipts = receipts
                for(var i=0; i < receipts.length; i++) {
                    var receipt = receipts[i];
                    receipt.created = getElapsedTime(receipt.created);

                    var tagHTML = '';

                    $.each(receipt.tags, function (j, item) {
                        tagHTML += '<div class="tagValue" onclick="removeTag(' + i +',' + j + ')">' + item + '&ensp;<button class="removeTagButtom">&#10005;</button></div>';                 
                    })
                    tagHTML += '<button class="add-tag" onclick="showTagInput('+ i + ')"> Add +</button>';
                    tagHTML = '<td class="tags">' + tagHTML + '</td>';

                    $(`<tr class="receipt">
                            <td class="time">${receipt.created}</td>
                            <td class="merchant">${receipt.merchantName}</td>
                            <td class="amount">${receipt.value}$</td>
                            ${tagHTML}
                        </tr>`)
                        .appendTo($("#receiptsTable"));
                }
            })
        }
    </script>

</head>

<body>
<DIV id="container">
    <h1 style="margin: 25px">My receipts</h1>
    <button class="button" id="add-receipt" style="margin: 25px" onclick="showPanel()">+</button>
    <div id="panelView" style="clear: both; text-align: center;"></div>
    <div id="receiptList" style="margin: 20px">
        <table class="table" id="receiptsTable" border="1" style="width:100%; text-align: center;">
          <tr>
            <th>Time</th>
            <th>Merchant</th>
            <th>$</th>
            <th>Tags</th>
          </tr>
        </table>
    </div>
</DIV>
</body>

<!-- UI related functions -->

<script type="text/javascript">
    function cancelAdding () {
        hidePanel();
    }

    function saveAdding () {
        var merchantName = $('#merchant').val();
        var amountValue = $('#amount').val();

        if (merchantName == "") {
            setErrorMessage('Please input Merchant name!');
            return;
        }

        if (amountValue != '' && !$.isNumeric(amountValue)) {
            setErrorMessage('Please input numberic Amount value!');
            return;
        }

        var parameters = {"merchant": merchantName, "amount": amountValue};

        AJAX_createReceipt(parameters);
    }

    function setErrorMessage(message) {
        $('#panelErrorView').text(message);
    }

    function clearErrorMessage() {
        $('#panelErrorView').text('');
    }

    function removeTag(recordIndex, tagIndex) {
        var thisRecord = allReceipts[recordIndex]
        var recordId = thisRecord.id;
        var tagName = thisRecord.tags[tagIndex];

        AJAX_updateTag(recordId, tagName);
    }

    function showPanel() {
        var template = $('#addReceip-template').html();
        $('#panelView').append(template);
        $("#add-receipt").attr("disabled", true);
    }

    function hidePanel() {
        $(".addReceiptPanel").remove();
        $("#add-receipt").attr("disabled", false);
    }

    function showTagInput(recordIndex) {
        var template = $('#tagInput-template').html();
        var thisRecord = allReceipts[recordIndex]
        var thisReceipt = $(".receipt")[recordIndex];
        var thisTagNode = $(".tags", thisReceipt);

        thisTagNode.append(template);
        $(".add-tag", thisReceipt).attr("disabled", true);

        $(".tag_input", thisTagNode).on('keypress', function (e) {
            if(e.which === 13){
                var tagName = $(this).val();
                if (tagName == '') return;
                $(this).attr("disabled", "disabled");
                AJAX_updateTag(thisRecord.id, tagName, thisTagNode);
            }
        });
    }

    function hideTagInput(tagNode) {
        $(".tag_input", tagNode).remove();
        $(".add-tag", $(".receipt")[recordIndex]).attr("disabled", false);
    }

</script>

<!-- TODO -->

<script type="text/javascript">

    function getElapsedTime(timeString) {
        var startDate = new Date("1/1/1900 " + timeString);
        var endDate = Date.now();
        var elapsed = endDate - startDate;
        return msToTime(elapsed);
    }

    // function getElapsedTime(timeString) {
    //     var currentTimeInSecond = (new Date().getHou);
    //     return msToTime(currentTimeInSecond - timeToSeconds(timeString));
    // }

    // function timeToSeconds(timeString) {
    //     timeString = timeString.split(/:/);
    //     return timeString[0] * 3600 + timeString[1] * 60 + timeString[2];
    // }

    function msToTime(duration) {
        var milliseconds = parseInt((duration%1000)/100)
            , seconds = parseInt((duration/1000)%60)
            , minutes = parseInt((duration/(1000*60))%60)
            , hours = parseInt((duration/(1000*60*60))%24);

        hours = (hours == 0) ? "": hours + "h ";
        minutes = (minutes == 0 && hours == 0) ? "": minutes + "m ";
        seconds = seconds + "s ago"

        return hours + minutes + seconds;
    }

</script>

<!-- AJAX -->

<script type="text/javascript">

    function AJAX_createReceipt(parameters) {
        $.ajax({
            beforeSend: function(xhrObj){
                xhrObj.setRequestHeader("Content-Type","application/json");
                xhrObj.setRequestHeader("Accept","application/json");
            },
            url: api+'/receipts',
            type: 'POST',
            data: JSON.stringify(parameters),
            success: function(result) {
                clearErrorMessage();
                hidePanel();
                $(reloadReceipts)
            },
            error: function(jqXHR, exception) {
                var err = 'Error: ' + jqXHR.responseText;
                setErrorMessage(err);
            }
        })
    }

    function AJAX_updateTag(recordId, tagName, tagNode) {
        $.ajax({
            beforeSend: function(xhrObj){
                xhrObj.setRequestHeader("Content-Type","application/json");
                xhrObj.setRequestHeader("Accept","application/json");
            },
            url: api+'/tags/' + tagName,
            type: 'PUT',
            data: JSON.stringify(recordId),
            success: function(result) {
                if (tagNode != null) {

                }
                $(reloadReceipts)
            },
            error: function(jqXHR, exception) {
                var err = 'Error: ' + jqXHR.responseText;
                setErrorMessage(err);
            }
        })
    }
</script>

<!-- template for add receipt panel and tag name input -->

<script id="addReceip-template" type="text/spark's-template">
    <div class="addReceiptPanel">
        <input type="text" id="merchant" class="receiptInput" name="merchantName" placeholder="merchant"><br>
        <input type="text" id="amount" class="receiptInput" name="amountValue" placeholder="amount"><br>

        <div style="display: flex; justify-content: flex-end; width: 85%">
            <button class="panelButton" id="cancel-receipt" style="background-color: red" onclick="cancelAdding()">cancel</button>
            <button class="panelButton" id="save-receipt" style="background-color: green" onclick="saveAdding()">save</button>
        </div>
        <center><div id="panelErrorView" class="panelError"></div></center>
    </div>
</script>

<script id="tagInput-template" type="text/spark's-template">
    <div>
        <input type="text" class="tag_input" name="tagInput"><br>
    </div>
</script>

</html>
